<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Review & Send · Email Matcher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .status-dot{width:10px;height:10px;border-radius:10px;display:inline-block;margin-right:6px}
      .pending{background:#adb5bd}.approved{background:#0d6efd}.sent{background:#198754}.skipped{background:#6c757d}
    </style>
  </head>
  <body class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Review &amp; Send</h1>
      <div>
        {% if gmail_connected %}
          <span class="badge text-bg-success me-2">Connected: {{ gmail_email or "Google user" }}</span>
        {% else %}
          <a class="btn btn-outline-danger btn-sm" href="/google/login">Connect Google to send</a>
        {% endif %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">← Back</a>
      </div>
    </div>
    <input type="text" name="subject_{{ loop.index0 }}" 
       value="{{ row.subject }}" 
       class="form-control form-control-lg" />
    <textarea name="body_{{ loop.index0 }}" 
          class="form-control" 
          rows="6">{{ row.body }}</textarea>



    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if not rows %}
      <div class="alert alert-warning">No emails to review. Start over.</div>
    {% else %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="small text-muted">
          Click **Approve** on the rows you want to send. You can edit the subject/body first.
        </div>
        {% if gmail_connected %}
          <form method="post" action="{{ url_for('review_send_all') }}">
            <button class="btn btn-primary btn-sm" type="submit">Send all approved</button>
          </form>
        {% endif %}
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr><th>Status</th><th>To</th><th>Name</th><th style="min-width:240px">Subject</th><th>Body</th><th style="width:220px">Actions</th></tr></thead>
          <tbody>
            {% for r in rows %}
              {% set i = loop.index0 %}
              <tr>
                <td>
                  {% set st = status[i] %}
                  <span class="status-dot {{ st }}"></span> {{ st }}
                </td>
                <td>{{ r.email }}</td>
                <td>{{ r.name }}</td>
                <td>
                  <form class="d-flex" method="post" action="{{ url_for('review_send_one') }}">
                    <input type="hidden" name="index" value="{{ i }}">
                    <input class="form-control form-control-sm" name="subject" value="{{ r.subject }}">
                </td>
                <td>
                    <textarea class="form-control form-control-sm" name="body" rows="4" style="white-space:pre-wrap">{{ r.body }}</textarea>
                </td>
                <td class="text-nowrap">
                  {% if gmail_connected %}
                    <button class="btn btn-success btn-sm mb-1" type="submit">Send</button>
                  {% else %}
                    <button class="btn btn-success btn-sm mb-1" disabled>Send</button>
                  {% endif %}
                  </form>

                  {% if gmail_connected %}
                    <form class="d-inline" method="post" action="{{ url_for('review_test_one') }}">
                      <input type="hidden" name="index" value="{{ i }}">
                      <input type="hidden" name="subject" value="{{ r.subject }}">
                      <input type="hidden" name="body" value="{{ r.body }}">
                      <button class="btn btn-outline-primary btn-sm mb-1" type="submit">Send test to me</button>
                    </form>
                  {% endif %}

                  {% if status[i] != 'approved' %}
                    <form class="d-inline" method="post" action="{{ url_for('review_approve') }}">
                      <input type="hidden" name="index" value="{{ i }}">
                      <button class="btn btn-outline-secondary btn-sm mb-1" type="submit">Approve</button>
                    </form>
                  {% else %}
                    <form class="d-inline" method="post" action="{{ url_for('review_unapprove') }}">
                      <input type="hidden" name="index" value="{{ i }}">
                      <button class="btn btn-outline-warning btn-sm mb-1" type="submit">Unapprove</button>
                    </form>
                  {% endif %}

                  <form class="d-inline" method="post" action="{{ url_for('review_skip_one') }}">
                    <input type="hidden" name="index" value="{{ i }}">
                    <button class="btn btn-outline-dark btn-sm mb-1" type="submit">Skip</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </body>
</html>
